name: Deploy (Premium79)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_NAME: office-app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          check-latest: true

      - name: Debug Environment
        run: |
          which node || echo "node not found"
          which npm || echo "npm not found"
          node -v
          npm -v

      - name: Install Frontend Dependencies
        working-directory: client
        run: npm install

      - name: Build Frontend
        working-directory: client
        env:
          NODE_ENV: production
          VITE_API_URL: /
        run: npm run build

      - name: Create Deployment Archive
        run: |
          tar -czf deploy.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=client/node_modules \
            --exclude=server/node_modules \
            --exclude=uploads \
            server \
            client/dist \
            package.json \
            package-lock.json

      - name: Upload Archive to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -Eeuo pipefail
            trap 'echo "ERROR: command failed at line $LINENO: $BASH_COMMAND"' ERR

            APP_NAME="office-app"
            APP_PATH="${{ secrets.SERVER_PATH }}"
            DEFAULT_APP_PATH="$HOME/office_app"
            if [ -z "$APP_PATH" ] || echo "$APP_PATH" | grep -Eq '<[^>]+>'; then
              APP_PATH="$DEFAULT_APP_PATH"
              echo "SERVER_PATH secret missing or placeholder. Falling back to: $APP_PATH"
            fi
            APP_PATH="$(echo "$APP_PATH" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            APP_PATH="${APP_PATH%/}"

            # Frontend deploy path (final directory path)
            # 1) Use FRONTEND_PATH secret when provided
            # 2) Otherwise fallback to the expected domain path
            DEFAULT_FRONTEND_PATH="/home/speeuvmq/my.speednetkhulna.com"
            FRONTEND_PATH="${{ secrets.FRONTEND_PATH }}"
            if [ -z "$FRONTEND_PATH" ] || echo "$FRONTEND_PATH" | grep -Eq '<[^>]+>'; then
              FRONTEND_PATH="$DEFAULT_FRONTEND_PATH"
              echo "FRONTEND_PATH secret missing or placeholder. Falling back to: $FRONTEND_PATH"
            fi
            FRONTEND_PATH="$(echo "$FRONTEND_PATH" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            FRONTEND_PATH="${FRONTEND_PATH%/}"

            # If configured path is not writable, fallback to the default path above.
            if ! mkdir -p "$FRONTEND_PATH" 2>/dev/null; then
              echo "FRONTEND_PATH is not writable: $FRONTEND_PATH"
              FRONTEND_PATH="$DEFAULT_FRONTEND_PATH"
              mkdir -p "$FRONTEND_PATH"
              echo "Fallback FRONTEND_PATH: $FRONTEND_PATH"
            fi

            echo "Resolved FRONTEND_PATH: $FRONTEND_PATH"
            echo "Resolved APP_PATH: $APP_PATH"

            # Ensure directories exist
            mkdir -p "$APP_PATH"
            mkdir -p "$FRONTEND_PATH"

            # Extract archive
            tar -xzf /tmp/deploy.tar.gz -C "$APP_PATH"
            rm -f /tmp/deploy.tar.gz

            # Ensure Node.js and npm are available on the server.
            if ! command -v npm > /dev/null 2>&1; then
              echo "npm not found. Trying common PATH locations first..."
              export PATH="$PATH:$HOME/bin:/usr/local/bin:/usr/bin:/bin:$HOME/.nvm/versions/node/v24/bin"
              hash -r
            fi

            if ! command -v npm > /dev/null 2>&1; then
              echo "npm still missing. Attempting auto-install (apt, then nvm)..."
              set +e

              # 1) Try apt-based install only when non-interactive sudo is available.
              if command -v apt-get > /dev/null 2>&1; then
                if command -v sudo > /dev/null 2>&1 && sudo -n true > /dev/null 2>&1; then
                  if command -v curl > /dev/null 2>&1; then
                    curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                  elif command -v wget > /dev/null 2>&1; then
                    wget -qO- https://deb.nodesource.com/setup_24.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                  fi
                else
                  echo "Skipping apt install (no non-interactive sudo)."
                fi
              fi

              # 2) Fallback: user-space install via nvm (no sudo required).
              if ! command -v npm > /dev/null 2>&1; then
                if command -v curl > /dev/null 2>&1; then
                  curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                elif command -v wget > /dev/null 2>&1; then
                  wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                fi

                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                command -v nvm > /dev/null 2>&1 && nvm install 24 && nvm use 24
              fi

              set -e
              hash -r
            fi

            if ! command -v npm > /dev/null 2>&1; then
              echo "ERROR: npm is not available on the server."
              echo "Install Node.js/npm manually on the target host, then rerun deployment."
              exit 1
            fi

            node -v
            npm -v

            # Setup Server
            echo "Phase: server dependencies"
            cd "$APP_PATH/server"
            # Try to install dependencies
            npm install --omit=dev || npm install

            # Create root .env from secrets (server code loads ../.env and ../../.env)
            echo "Phase: write environment file"
            if [ -z "${{ secrets.DB_HOST }}" ]; then
              echo "ERROR: DB_HOST is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.DB_PORT }}" ]; then
              echo "ERROR: DB_PORT is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.DB_USER }}" ]; then
              echo "ERROR: DB_USER is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
              echo "ERROR: DB_PASSWORD is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.DB_NAME }}" ]; then
              echo "ERROR: DB_NAME is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.JWT_SECRET }}" ]; then
              echo "ERROR: JWT_SECRET is missing in GitHub repository secrets."
              exit 1
            fi
            if [ -z "${{ secrets.SESSION_SECRET }}" ]; then
              echo "ERROR: SESSION_SECRET is missing in GitHub repository secrets."
              exit 1
            fi
            if ! echo "${{ secrets.DB_PORT }}" | grep -Eq '^[0-9]+$'; then
              echo "ERROR: DB_PORT must be numeric."
              exit 1
            fi

            ENV_FILE="$APP_PATH/.env"
            : > "$ENV_FILE"
            echo "PORT=5000" >> "$ENV_FILE"
            echo "NODE_ENV=production" >> "$ENV_FILE"
            echo "DB_HOST=${{ secrets.DB_HOST }}" >> "$ENV_FILE"
            echo "DB_PORT=${{ secrets.DB_PORT }}" >> "$ENV_FILE"
            echo "DB_USER=${{ secrets.DB_USER }}" >> "$ENV_FILE"
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> "$ENV_FILE"
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> "$ENV_FILE"
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> "$ENV_FILE"
            echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> "$ENV_FILE"
            echo "TZ=Asia/Dhaka" >> "$ENV_FILE"
            echo "FRONTEND_URL=https://my.speednetkhulna.com" >> "$ENV_FILE"
            chmod 600 "$ENV_FILE" || true
            echo "Environment file written: $ENV_FILE"

            # Validate DB connectivity before starting app
            echo "Phase: database precheck"
            node -e "const dotenv=require('dotenv'); const {Pool}=require('pg'); dotenv.config({path:'$APP_PATH/.env'}); const pool=new Pool({host:process.env.DB_HOST,port:Number(process.env.DB_PORT||5432),user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME}); pool.query('SELECT 1').then(()=>{console.log('DB precheck: connection successful'); return pool.end();}).then(()=>process.exit(0)).catch((err)=>{console.error('DB precheck failed:', err.message); process.exit(1);});"

            # Validate required table permissions for app user
            echo "Phase: database permission precheck"
            node -e "const dotenv=require('dotenv'); const {Pool}=require('pg'); dotenv.config({path:'$APP_PATH/.env'}); const appUser=process.env.DB_USER; const pool=new Pool({host:process.env.DB_HOST,port:Number(process.env.DB_PORT||5432),user:appUser,password:process.env.DB_PASSWORD,database:process.env.DB_NAME}); pool.query('SELECT COUNT(*) FROM public.users').then(()=>{console.log('DB permissions precheck: users table access OK'); return pool.end();}).then(()=>process.exit(0)).catch(async (err)=>{if(err && err.code==='42501'){let owner='unknown'; try{const r=await pool.query(\"SELECT tableowner FROM pg_tables WHERE schemaname='public' AND tablename='users' LIMIT 1\"); if(r.rows && r.rows[0] && r.rows[0].tableowner){owner=r.rows[0].tableowner;}}catch(_e){} console.error('DB permissions precheck failed: permission denied for relation users (code 42501).'); console.error('Current DB user: '+appUser+', users table owner: '+owner); console.error('Run these SQL statements as the table owner/admin:'); console.error('GRANT USAGE ON SCHEMA public TO '+appUser+';'); console.error('GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO '+appUser+';'); console.error('GRANT USAGE, SELECT, UPDATE ON ALL SEQUENCES IN SCHEMA public TO '+appUser+';'); console.error('ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO '+appUser+';'); console.error('ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT, UPDATE ON SEQUENCES TO '+appUser+';'); try{await pool.end();}catch(_x){} process.exit(1);} console.error('DB permissions precheck failed:', err.message); try{await pool.end();}catch(_y){} process.exit(1);});"

            # Start/Restart with PM2
            echo "Phase: pm2 process"
            export PM2_HOME="$APP_PATH/.pm2"
            mkdir -p "$PM2_HOME"

            PM2_BIN="pm2"
            if ! command -v pm2 > /dev/null 2>&1; then
              echo "pm2 not found globally. Installing local pm2 in server..."
              npm install pm2 --no-save
              PM2_BIN="$APP_PATH/server/node_modules/.bin/pm2"
            fi

            "$PM2_BIN" -v
            "$PM2_BIN" delete "$APP_NAME" > /dev/null 2>&1 || true

            set +e
            "$PM2_BIN" start index.js --name "$APP_NAME" --update-env
            PM2_START_RC=$?
            set -e

            if [ "$PM2_START_RC" -ne 0 ]; then
              echo "PM2 failed to start app (exit code: $PM2_START_RC)."
              "$PM2_BIN" status || true
              "$PM2_BIN" logs "$APP_NAME" --lines 120 --nostream || true
              exit 1
            fi

            PM2_PID=$("$PM2_BIN" pid "$APP_NAME" | tail -n 1 || true)
            if [ -z "$PM2_PID" ] || [ "$PM2_PID" = "0" ]; then
              echo "PM2 reports app is not online right after start."
              "$PM2_BIN" status || true
              "$PM2_BIN" logs "$APP_NAME" --lines 120 --nostream || true
              exit 1
            fi

            "$PM2_BIN" save || echo "Warning: pm2 save failed; continuing deployment."

            # Deploy frontend bundle to FRONTEND_PATH
            echo "Phase: deploy frontend files"
            if [ ! -f "$APP_PATH/client/dist/index.html" ]; then
              echo "ERROR: frontend build artifacts missing at $APP_PATH/client/dist/index.html"
              exit 1
            fi
            find "$FRONTEND_PATH" -mindepth 1 -maxdepth 1 -exec rm -rf {} +
            cp -a "$APP_PATH/client/dist/." "$FRONTEND_PATH/"

            # Write .htaccess for SPA routing and API proxy to Node backend
            echo "Phase: write frontend .htaccess"
            HTACCESS_FILE="$FRONTEND_PATH/.htaccess"
            : > "$HTACCESS_FILE"
            echo "RewriteEngine On" >> "$HTACCESS_FILE"
            echo "RewriteRule ^api/(.*)$ http://127.0.0.1:5000/api/\$1 [P,L]" >> "$HTACCESS_FILE"
            echo "RewriteRule ^uploads/(.*)$ http://127.0.0.1:5000/uploads/\$1 [P,L]" >> "$HTACCESS_FILE"
            echo "RewriteCond %{REQUEST_FILENAME} -f [OR]" >> "$HTACCESS_FILE"
            echo "RewriteCond %{REQUEST_FILENAME} -d" >> "$HTACCESS_FILE"
            echo "RewriteRule ^ - [L]" >> "$HTACCESS_FILE"
            echo "RewriteRule ^ index.html [L]" >> "$HTACCESS_FILE"
            chmod 644 "$HTACCESS_FILE" || true
            echo ".htaccess written at: $HTACCESS_FILE"

            # Health check with retries
            echo "Phase: health check"
            node -e "const http=require('http'); const max=12; const delay=5000; let attempt=1; const run=()=>{const req=http.get('http://127.0.0.1:5000/api/health',(res)=>{let body=''; res.on('data',(c)=>body+=c); res.on('end',()=>{console.log('Health response attempt '+attempt+'/'+max+': '+body); const ok=res.statusCode===200 && body.includes('\"status\":\"OK\"'); if(ok){console.log('Health check passed.'); process.exit(0);} if(attempt>=max){console.error('Health check failed after '+max+' attempts.'); process.exit(1);} attempt+=1; setTimeout(run,delay);});}); req.on('error',(err)=>{console.log('Health response attempt '+attempt+'/'+max+': request error: '+err.message); if(attempt>=max){console.error('Health check failed after '+max+' attempts.'); process.exit(1);} attempt+=1; setTimeout(run,delay);});}; run();"
            HEALTH_RC=$?
            [ "$HEALTH_RC" -eq 0 ] || { "$PM2_BIN" logs "$APP_NAME" --lines 120 --nostream || true; exit 1; }

      - name: Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "Deployment successful."
          else
            echo "Deployment failed."
            exit 1
          fi
