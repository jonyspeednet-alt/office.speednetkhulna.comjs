name: Deploy (Premium79)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_NAME: office-app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          check-latest: true

      - name: Debug Environment
        run: |
          which node || echo "node not found"
          which npm || echo "npm not found"
          node -v
          npm -v

      - name: Install Frontend Dependencies
        working-directory: client
        run: npm install

      - name: Build Frontend
        working-directory: client
        env:
          NODE_ENV: production
          VITE_API_URL: https://my.speednetkhulna.com
        run: npm run build

      - name: Create Deployment Archive
        run: |
          tar -czf deploy.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=client/node_modules \
            --exclude=server/node_modules \
            --exclude=uploads \
            server \
            client/dist \
            package.json \
            package-lock.json

      - name: Upload Archive to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -e

            APP_NAME="office-app"
            APP_PATH="${{ secrets.SERVER_PATH }}"
            # New domain folder path
            FRONTEND_PATH="${{ secrets.FRONTEND_PATH }}/my.speednetkhulna.com"

            # Ensure directories exist
            mkdir -p "$APP_PATH"
            mkdir -p "$FRONTEND_PATH"

            # Extract archive
            tar -xzf /tmp/deploy.tar.gz -C "$APP_PATH"
            rm -f /tmp/deploy.tar.gz

            # Ensure Node.js and npm are available on the server.
            if ! command -v npm > /dev/null 2>&1; then
              echo "npm not found. Trying common PATH locations first..."
              export PATH="$PATH:$HOME/bin:/usr/local/bin:/usr/bin:/bin:$HOME/.nvm/versions/node/v24/bin"
              hash -r
            fi

            if ! command -v npm > /dev/null 2>&1; then
              echo "npm still missing. Attempting auto-install (apt, then nvm)..."
              set +e

              # 1) Try apt-based install only when non-interactive sudo is available.
              if command -v apt-get > /dev/null 2>&1; then
                if command -v sudo > /dev/null 2>&1 && sudo -n true > /dev/null 2>&1; then
                  if command -v curl > /dev/null 2>&1; then
                    curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                  elif command -v wget > /dev/null 2>&1; then
                    wget -qO- https://deb.nodesource.com/setup_24.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                  fi
                else
                  echo "Skipping apt install (no non-interactive sudo)."
                fi
              fi

              # 2) Fallback: user-space install via nvm (no sudo required).
              if ! command -v npm > /dev/null 2>&1; then
                if command -v curl > /dev/null 2>&1; then
                  curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                elif command -v wget > /dev/null 2>&1; then
                  wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                fi

                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                command -v nvm > /dev/null 2>&1 && nvm install 24 && nvm use 24
              fi

              set -e
              hash -r
            fi

            if ! command -v npm > /dev/null 2>&1; then
              echo "ERROR: npm is not available on the server."
              echo "Install Node.js/npm manually on the target host, then rerun deployment."
              exit 1
            fi

            node -v
            npm -v

            # Setup Server
            cd "$APP_PATH/server"
            # Try to install dependencies
            npm install --production || npm install

            # Create root .env from secrets (server code loads ../.env and ../../.env)
            cat > "$APP_PATH/.env" <<EOF
            PORT=5000
            NODE_ENV=production
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            TZ=Asia/Dhaka
            FRONTEND_URL=https://my.speednetkhulna.com
            EOF

            # Start/Restart with PM2
            if ! command -v pm2 > /dev/null 2>&1; then
              npm install -g pm2
            fi
            if pm2 describe "$APP_NAME" > /dev/null 2>&1; then
              pm2 restart "$APP_NAME" --update-env
            else
              pm2 start index.js --name "$APP_NAME"
            fi
            pm2 save

            # Deploy Frontend to public_html
            rm -rf "$FRONTEND_PATH"/*
            cp -r "$APP_PATH/client/dist/"* "$FRONTEND_PATH"/

            # Health check with retries
            ATTEMPT=1
            MAX_ATTEMPTS=12
            until curl -fsS http://localhost:5000/api/health > /dev/null; do
              if [ "$ATTEMPT" -ge "$MAX_ATTEMPTS" ]; then
                echo "Health check failed after ${MAX_ATTEMPTS} attempts."
                pm2 logs "$APP_NAME" --lines 120 --nostream || true
                exit 1
              fi
              echo "Health check attempt ${ATTEMPT}/${MAX_ATTEMPTS} failed. Retrying in 5s..."
              ATTEMPT=$((ATTEMPT + 1))
              sleep 5
            done

      - name: Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "Deployment successful."
          else
            echo "Deployment failed."
            exit 1
          fi
